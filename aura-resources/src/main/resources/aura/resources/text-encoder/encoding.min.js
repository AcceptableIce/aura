// Copyright 2014 Joshua Bell. All rights reserved.
//
// Licensed under the Apache License, Version 2.0 (the "License");
// you may not use this file except in compliance with the License.
// You may obtain a copy of the License at
//
//     http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software
// distributed under the License is distributed on an "AS IS" BASIS,
// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
// See the License for the specific language governing permissions and
// limitations under the License.
(function(m){function n(a){if(void 0===a)return{};if(a===Object(a))return a;throw new TypeError("Could not convert argument to dictionary");}function r(a){this.tokens=[].slice.call(a)}function t(a,d){if(a)throw new TypeError("Decoder error");return d||65533}function u(a){a=String(a).trim().toLowerCase();return Object.prototype.hasOwnProperty.call(v,a)?v[a]:null}function p(a,d){if(!(this instanceof p))return new p(a,d);a=void 0!==a?String(a):"utf-8";d=n(d);this._encoding=u(a);if(null===this._encoding||
"replacement"===this._encoding.name)throw new RangeError("Unknown encoding: "+a);this._BOMseen=this._streaming=!1;this._decoder=null;this._fatal=Boolean(d.fatal);this._ignoreBOM=Boolean(d.ignoreBOM);Object.defineProperty?(Object.defineProperty(this,"encoding",{value:this._encoding.name}),Object.defineProperty(this,"fatal",{value:this._fatal}),Object.defineProperty(this,"ignoreBOM",{value:this._ignoreBOM})):(this.encoding=this._encoding.name,this.fatal=this._fatal,this.ignoreBOM=this._ignoreBOM);return this}
function q(a,d){if(!(this instanceof q))return new q(a,d);a=void 0!==a?String(a):"utf-8";d=n(d);this._encoding=u(a);if(null===this._encoding||"replacement"===this._encoding.name)throw new RangeError("Unknown encoding: "+a);var b=Boolean(d.NONSTANDARD_allowLegacyEncoding),e="utf-8"!==this._encoding.name&&"utf-16le"!==this._encoding.name&&"utf-16be"!==this._encoding.name;if(null===this._encoding||e&&!b)throw new RangeError("Unknown encoding: "+a);this._streaming=!1;this._encoder=null;this._options=
{fatal:Boolean(d.fatal)};Object.defineProperty?Object.defineProperty(this,"encoding",{value:this._encoding.name}):this.encoding=this._encoding.name;return this}function y(a){var d=a.fatal,b=0,e=0,c=0,g=128,h=191;this.handler=function(a,f){if(-1===f&&0!==c)return c=0,t(d);if(-1===f)return-1;if(0===c){if(0<=f&&127>=f)return f;if(194<=f&&223>=f)c=1,b=f-192;else if(224<=f&&239>=f)224===f&&(g=160),237===f&&(h=159),c=2,b=f-224;else if(240<=f&&244>=f)240===f&&(g=144),244===f&&(h=143),c=3,b=f-240;else return t(d);
b<<=6*c;return null}if(!(g<=f&&f<=h))return b=c=e=0,g=128,h=191,a.prepend(f),t(d);g=128;h=191;e+=1;b+=f-128<<6*(c-e);if(e!==c)return null;var l=b;b=c=e=0;return l}}function z(){this.handler=function(a,d){if(-1===d)return-1;if(0<=d&&127>=d)return d;var b,e;128<=d&&2047>=d?(b=1,e=192):2048<=d&&65535>=d?(b=2,e=224):65536<=d&&1114111>=d&&(b=3,e=240);for(e=[(d>>6*b)+e];0<b;)e.push(128|d>>6*(b-1)&63),--b;return e}}r.prototype={endOfStream:function(){return!this.tokens.length},read:function(){return this.tokens.length?
this.tokens.shift():-1},prepend:function(a){if(Array.isArray(a))for(;a.length;)this.tokens.unshift(a.pop());else this.tokens.unshift(a)},push:function(a){if(Array.isArray(a))for(;a.length;)this.tokens.push(a.shift());else this.tokens.push(a)}};var v={"utf-8":{name:"utf-8"},utf8:{name:"utf-8"}},w={},x={};p.prototype={decode:function(a,d){var b;b="object"===typeof a&&a instanceof ArrayBuffer?new Uint8Array(a):"object"===typeof a&&"buffer"in a&&a.buffer instanceof ArrayBuffer?new Uint8Array(a.buffer,
a.byteOffset,a.byteLength):new Uint8Array(0);d=n(d);this._streaming||(this._decoder=x[this._encoding.name]({fatal:this._fatal}),this._BOMseen=!1);this._streaming=Boolean(d.stream);var e=new r(b);b=[];for(var c;!e.endOfStream();){c=this._decoder.handler(e,e.read());if(-1===c)break;null!==c&&(Array.isArray(c)?b.push.apply(b,c):b.push(c))}if(!this._streaming){do{c=this._decoder.handler(e,e.read());if(-1===c)break;null!==c&&(Array.isArray(c)?b.push.apply(b,c):b.push(c))}while(!e.endOfStream());this._decoder=
null}!b.length||-1===["utf-8","utf-16le","utf-16be"].indexOf(this.encoding)||this._ignoreBOM||this._BOMseen||(65279===b[0]?(this._BOMseen=!0,b.shift()):this._BOMseen=!0);e="";for(c=0;c<b.length;++c){var g=b[c];65535>=g?e+=String.fromCharCode(g):(g-=65536,e+=String.fromCharCode((g>>10)+55296,(g&1023)+56320))}return e}};q.prototype={encode:function(a,d){a=a?String(a):"";d=n(d);this._streaming||(this._encoder=w[this._encoding.name](this._options));this._streaming=Boolean(d.stream);for(var b=[],e=a,c=
String(e),g=c.length,h=0,k=[];h<g;){var f=c.charCodeAt(h);if(55296>f||57343<f)k.push(f);else if(56320<=f&&57343>=f)k.push(65533);else if(55296<=f&&56319>=f)if(h===g-1)k.push(65533);else{var l=e.charCodeAt(h+1);56320<=l&&57343>=l?(k.push(65536+((f&1023)<<10)+(l&1023)),h+=1):k.push(65533)}h+=1}for(e=new r(k);!e.endOfStream();){c=this._encoder.handler(e,e.read());if(-1===c)break;Array.isArray(c)?b.push.apply(b,c):b.push(c)}if(!this._streaming){for(;;){c=this._encoder.handler(e,e.read());if(-1===c)break;
Array.isArray(c)?b.push.apply(b,c):b.push(c)}this._encoder=null}return new Uint8Array(b)}};w["utf-8"]=function(a){return new z(a)};x["utf-8"]=function(a){return new y(a)};"TextEncoder"in m||(m.TextEncoder=q);"TextDecoder"in m||(m.TextDecoder=p)})(window);